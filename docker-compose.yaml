version: '3.8'

services:
  open-webui:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        OLLAMA_BASE_URL: '/ollama'
    image: open-webui:local-dev-zxai
    container_name: open-webui
    
    # ✅ 核心修复 1：加载你的环境变量文件
    env_file:
      - .env

    volumes:
      - open-webui-local-data:/app/backend/data
    ports:
      - "3000:8080"
    
    environment:
      - 'WEBUI_SECRET_KEY=dev_secret_key'
      # ✅ 核心修复 2：告诉后端 Redis 在哪（容器间通信用服务名）
      - 'REDIS_URL=redis://redis:6379/0'
      # 确保这个开关打开，否则按钮不显示
      - 'ENABLE_OAUTH_SIGNUP=True'

    extra_hosts:
      - "host.docker.internal:host-gateway"
    
    # ✅ 核心修复 3：确保 Redis 启动了后端再启动
    depends_on:
      - redis
    restart: unless-stopped

  # ✅ 必须加个 Redis，不然验证码没地方存
  redis:
    image: redis:alpine
    container_name: redis
    expose:
      - "6379"

volumes:
  open-webui-local-data: {}